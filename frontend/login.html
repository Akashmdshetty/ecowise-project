<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>EcoWise — Login</title>
  <meta name="description" content="Login to EcoWise — AI Circular Economy Platform">

  <style>
    :root{
      --bg:#f4f7f9;
      --card:#ffffff;
      --brand:#10B981;
      --muted:#6b7280;
      --danger:#ef4444;
      --glass: rgba(2,6,23,0.04);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, system-ui, Arial, Helvetica, sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      background:linear-gradient(180deg,var(--bg),#eef2f7);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
    }

    .card{
      width:360px;
      border-radius:12px;
      padding:22px;
      background:var(--card);
      box-shadow: 0 10px 30px rgba(16,24,40,0.08);
      border:1px solid var(--glass);
    }

    h1{font-size:1.1rem;margin:0 0 8px 0}
    p.lead{margin:0 0 16px 0;color:var(--muted);font-size:0.95rem}

    form{display:flex;flex-direction:column;gap:10px}
    label{font-size:0.82rem;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"], input[type="password"], input[type="email"]{
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid #e6e9ee;
      background:#fff;
      font-size:0.95rem;
    }
    .field {
      display:flex;
      flex-direction:column;
    }

    .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .checkbox{display:flex;gap:8px;align-items:center}
    .small{font-size:0.85rem;color:var(--muted)}

    button[type="submit"]{
      margin-top:6px;
      background:linear-gradient(90deg,var(--brand),#059669);
      color:white;
      border:none;
      padding:10px 12px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    button[disabled]{opacity:0.6;cursor:not-allowed}

    .muted-link{color:var(--muted);text-decoration:none;font-size:0.9rem}
    .muted-link:hover{text-decoration:underline}

    .msg{height:20px;font-size:0.9rem;color:var(--danger);margin-top:6px}

    .password-wrap{position:relative}
    .toggle-pass{
      position:absolute;
      right:8px;
      top:50%;
      transform:translateY(-50%);
      background:none;
      border:none;
      color:var(--muted);
      cursor:pointer;
      padding:6px;
      border-radius:6px;
    }

    .spinner{
      width:16px;height:16px;border:2px solid rgba(255,255,255,0.35);border-left-color:white;border-radius:50%;
      animation:spin 0.9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .footer{margin-top:12px;text-align:center;font-size:0.85rem;color:var(--muted)}
    .footer a{color:var(--brand);text-decoration:none}
    .sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <main class="card" role="main" aria-labelledby="loginTitle">
    <h1 id="loginTitle">Welcome back to EcoWise</h1>
    <p class="lead">Sign in to track your EcoPoints, analyze items, and find local recycling centers.</p>

    <form id="loginForm" autocomplete="on" novalidate>
      <div class="field">
        <label for="username">Username or email</label>
        <input id="username" name="username" type="text" inputmode="email" autocomplete="username" placeholder="you@example.com" aria-describedby="usernameHelp" required>
        <div id="usernameHelp" class="small muted">Use the email you registered with (or your username).</div>
      </div>

      <div class="field password-wrap">
        <label for="password">Password</label>
        <input id="password" name="password" type="password" autocomplete="current-password" placeholder="••••••••" required aria-describedby="pwHelp">
        <button type="button" class="toggle-pass" id="togglePassword" aria-label="Show password">Show</button>
        <div id="pwHelp" class="small muted">Minimum 8 characters recommended.</div>
      </div>

      <div class="row" style="align-items:center">
        <label class="checkbox">
          <input id="remember" type="checkbox" aria-label="Remember me">
          <span class="small">Remember me</span>
        </label>
        <a class="muted-link" href="forgot-password.html">Forgot?</a>
      </div>

      <div>
        <button id="loginBtn" type="submit" aria-live="polite">
          <span id="btnText">Login</span>
          <span id="btnSpinner" style="display:none" aria-hidden="true" class="spinner"></span>
        </button>
      </div>

      <div id="msg" class="msg" role="status" aria-live="polite"></div>
    </form>

    <div class="footer">
      <div>Don't have an account? <a href="register.html">Create one</a></div>
    </div>
  </main>

  <script>
    (function(){
      'use strict';

      // Config — change if backend runs at other address
      const API_BASE = window.API_BASE || 'http://localhost:4000/api';
      const TIMEOUT_MS = 10_000;

      // Elements
      const form = document.getElementById('loginForm');
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      const rememberCheckbox = document.getElementById('remember');
      const loginBtn = document.getElementById('loginBtn');
      const btnText = document.getElementById('btnText');
      const btnSpinner = document.getElementById('btnSpinner');
      const msg = document.getElementById('msg');
      const togglePass = document.getElementById('togglePassword');

      // UX helpers
      function setLoading(isLoading){
        loginBtn.disabled = isLoading;
        if (isLoading){
          btnSpinner.style.display = '';
          btnText.textContent = 'Signing in…';
        } else {
          btnSpinner.style.display = 'none';
          btnText.textContent = 'Login';
        }
      }
      function showError(s){ msg.textContent = s || ''; }
      function clearError(){ msg.textContent = ''; }

      // Toggle password visibility
      togglePass.addEventListener('click', () => {
        const t = passwordInput;
        if (t.type === 'password'){
          t.type = 'text';
          togglePass.textContent = 'Hide';
          togglePass.setAttribute('aria-label','Hide password');
        } else {
          t.type = 'password';
          togglePass.textContent = 'Show';
          togglePass.setAttribute('aria-label','Show password');
        }
      });

      // Basic client-side validation
      function validateForm(){
        const username = usernameInput.value.trim();
        const password = passwordInput.value;
        if (!username) { showError('Please enter username or email.'); usernameInput.focus(); return false; }
        if (!password || password.length < 4) { showError('Password is required.'); passwordInput.focus(); return false; }
        clearError();
        return true;
      }

      // Helper: fetch with timeout + JSON parse
      async function fetchWithTimeout(url, opts = {}, timeout = TIMEOUT_MS){
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        try {
          const res = await fetch(url, { signal: controller.signal, ...opts });
          clearTimeout(id);
          const text = await res.text();
          let json = null;
          try { json = text ? JSON.parse(text) : {}; } catch(e){ json = { error: 'Invalid JSON from server' }; }
          return { status: res.status, ok: res.ok, body: json };
        } catch (err) {
          clearTimeout(id);
          throw err;
        }
      }

      // On successful login: save token and optionally username
      function handleSuccessfulLogin(data, usernameValue){
        // token expected in data.token
        if (data && data.token){
          localStorage.setItem('ecowise_token', data.token);
          // optionally persist username when "remember me" checked
          if (rememberCheckbox.checked) localStorage.setItem('ecowise_username', usernameValue);
          else localStorage.removeItem('ecowise_username');
          // redirect to dashboard or to provided next param
          const params = new URLSearchParams(window.location.search);
          const next = params.get('next') || 'dashboard.html';
          window.location.href = next;
        } else {
          showError('Login succeeded but no token received.');
        }
      }

      // Submit handler
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!validateForm()) return;
        setLoading(true);
        clearError();

        const username = usernameInput.value.trim();
        const password = passwordInput.value;

        try {
          const payload = { username, password };
          const { status, ok, body } = await fetchWithTimeout(API_BASE + '/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!ok){
            // prefer server error message, else generic
            const serverMsg = body && (body.error || body.message) ? (body.error || body.message) : `Login failed (${status})`;
            showError(serverMsg);
            setLoading(false);
            return;
          }

          // success
          handleSuccessfulLogin(body, username);
        } catch (err) {
          if (err && err.name === 'AbortError') showError('Request timed out. Check your network.');
          else showError('Network error — please try again.');
          console.error('Login error:', err);
          setLoading(false);
        }
      });

      // UX: press Enter on inputs triggers submit (form handles it)
      [usernameInput, passwordInput].forEach(el => {
        el.addEventListener('input', () => { if (msg.textContent) clearError(); });
      });

      // Prefill username if remembered
      (function prefill(){
        try {
          const saved = localStorage.getItem('ecowise_username');
          if (saved) usernameInput.value = saved;
        } catch(e){ /* ignore */ }
      })();

      // Accessibility: focus username on load
      usernameInput.focus();

      // Expose small helper for debugging in console
      window._ecowise = window._ecowise || {};
      window._ecowise.loginForm = form;
      window._ecowise.setLoading = setLoading;

    })();
  </script>
</body>
</html>
